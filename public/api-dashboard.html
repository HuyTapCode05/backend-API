<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: #1a1a1a;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .logo {
            padding: 0 20px 30px;
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 20px;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: #252525;
        }

        .nav-item.active {
            background: #2a2a2a;
            border-left: 3px solid #4a9eff;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            border-bottom: 1px solid #2a2a2a;
            background: #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.total .value { color: #4a9eff; }
        .stat-card.active .value { color: #ffa500; }
        .stat-card.success .value { color: #4caf50; }
        .stat-card.error .value { color: #f44336; }

        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .endpoint-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .endpoint-item {
            background: #252525;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .endpoint-info {
            flex: 1;
        }

        .endpoint-method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .method-get { background: #4caf50; color: white; }
        .method-post { background: #2196f3; color: white; }
        .method-put { background: #ff9800; color: white; }
        .method-delete { background: #f44336; color: white; }

        .endpoint-path {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }

        .endpoint-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4a9eff;
            color: white;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
        }

        .test-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .test-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: #888;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background: #252525;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .response-area {
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-area pre {
            color: #4caf50;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .response-area.error pre {
            color: #f44336;
        }

        .activity-item {
            padding: 12px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a9eff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            color: #888;
            font-size: 12px;
        }

        .hidden {
            display: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success { background: #4caf50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">API Dashboard</div>
        <div class="nav-item active" data-page="dashboard">
            <span>üìä</span> Dashboard
        </div>
        <div class="nav-item" data-page="quicktests">
            <span>‚ö°</span> Quick Tests
        </div>
        <div class="nav-item" data-page="endpoints">
            <span>üîå</span> Endpoints
        </div>
        <div class="nav-item" data-page="test">
            <span>üß™</span> Test API
        </div>
        <div class="nav-item" data-page="activity">
            <span>üìù</span> Activity
        </div>
        <div class="nav-item" data-page="settings">
            <span>‚öôÔ∏è</span> Settings
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1 id="page-title">Dashboard</h1>
            <div>
                <span id="server-status" class="status-badge status-pending">Checking...</span>
            </div>
        </div>

        <div class="content">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <h3>Total Endpoints</h3>
                        <div class="value" id="stat-total">0</div>
                    </div>
                    <div class="stat-card active">
                        <h3>Active Requests</h3>
                        <div class="value" id="stat-active">0</div>
                    </div>
                    <div class="stat-card success">
                        <h3>Success Rate</h3>
                        <div class="value" id="stat-success">0%</div>
                    </div>
                    <div class="stat-card error">
                        <h3>Errors</h3>
                        <div class="value" id="stat-errors">0</div>
                    </div>
                </div>

                <div class="section">
                    <h2>Quick Actions</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="testEndpoint('GET', '/api/health')">Test Health</button>
                        <button class="btn btn-primary" onclick="testEndpoint('GET', '/api')">Get API Info</button>
                        <button class="btn btn-secondary" onclick="loadEndpoints()">Refresh Endpoints</button>
                    </div>
                </div>

                <div class="section">
                    <h2>Server Information</h2>
                    <div id="server-info" style="color: #888;">Loading...</div>
                </div>
            </div>

            <!-- Endpoints Page -->
            <div id="page-endpoints" class="page hidden">
                <div class="section">
                    <h2>Available Endpoints</h2>
                    <div class="endpoint-list" id="endpoints-list">
                        <div style="color: #888; text-align: center; padding: 20px;">Loading endpoints...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Tests Page -->
            <div id="page-quicktests" class="page hidden">
                <div class="section">
                    <h2>1-Click Presets</h2>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;">
                        <button class="btn btn-primary" onclick="runSmokeTest()">Run Smoke Test</button>
                        <button class="btn btn-secondary" onclick="renderQuickTests()">Reload Presets</button>
                    </div>
                    <div style="color:#888; font-size: 13px; margin-bottom: 12px;">
                        Tip: preset n√†o c·∫ßn token th√¨ app s·∫Ω auto g·∫Øn <code>Authorization: Bearer</code> t·ª´ Settings. C√°c ID/token s·∫Ω auto l∆∞u v√†o Variables sau m·ªói request.
                    </div>
                    <div class="endpoint-list" id="quicktests-list">
                        <div style="color: #888; text-align: center; padding: 20px;">Loading presets...</div>
                    </div>
                </div>

                <div class="test-panel">
                    <h2>Quick Test Response</h2>
                    <div class="response-area" id="quicktest-response" style="display: none;">
                        <pre id="quicktest-response-content"></pre>
                    </div>
                </div>
            </div>

            <!-- Test API Page -->
            <div id="page-test" class="page hidden">
                <div class="test-panel">
                    <h2>Test API Endpoint</h2>
                    <div class="section" style="margin-top: 0; margin-bottom: 15px;">
                        <h2 style="margin-bottom: 10px;">Load Preset (kh·ªèi g√µ JSON)</h2>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                            <select id="preset-select" style="min-width: 320px;"></select>
                            <button class="btn btn-secondary" type="button" onclick="loadSelectedPreset()">Load</button>
                            <button class="btn btn-primary" type="button" onclick="runSelectedPreset()">Run</button>
                        </div>
                        <div style="color:#888; font-size: 12px; margin-top: 8px;">
                            Variables: <code>${"{ACCESS_TOKEN}"}</code>, <code>${"{REFRESH_TOKEN}"}</code>, <code>${"{USER_ID}"}</code>, <code>${"{GROUP_ID}"}</code>, <code>${"{MESSAGE_ID}"}</code>, <code>${"{ROOM_ID}"}</code>...
                        </div>
                    </div>
                    <form class="test-form" onsubmit="handleTestSubmit(event)">
                        <div class="form-group">
                            <label>Method</label>
                            <select id="test-method">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>URL</label>
                            <input type="text" id="test-url" placeholder="http://localhost:3000/api/auth/login" value="http://localhost:3000">
                        </div>
                        <div class="form-group">
                            <label>Headers (JSON)</label>
                            <textarea id="test-headers" placeholder='{"Content-Type": "application/json"}'></textarea>
                        </div>
                        <div class="form-group">
                            <label>Body (JSON)</label>
                            <textarea id="test-body" placeholder='{"username": "test", "password": "test"}'></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Request</button>
                    </form>
                    <div class="response-area" id="test-response" style="display: none;">
                        <h3 style="margin-bottom: 10px;">Response</h3>
                        <pre id="test-response-content"></pre>
                    </div>
                </div>
            </div>

            <!-- Activity Page -->
            <div id="page-activity" class="page hidden">
                <div class="section">
                    <h2>Recent Activity</h2>
                    <div id="activity-list">
                        <div style="color: #888; text-align: center; padding: 20px;">No activity yet</div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page hidden">
                <div class="section">
                    <h2>API Configuration</h2>
                    <div class="form-group">
                        <label>Base URL</label>
                        <input type="text" id="base-url" value="http://localhost:3000" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label>Access Token (Optional)</label>
                        <input type="password" id="access-token" placeholder="Bearer token" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label>Refresh Token (Optional)</label>
                        <input type="password" id="refresh-token" placeholder="refreshToken" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label>Variables (IDs)</label>
                        <textarea id="vars-json" placeholder='{\"USER_ID\":\"...\",\"GROUP_ID\":\"...\",\"MESSAGE_ID\":\"...\",\"ROOM_ID\":\"room123\"}'></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = localStorage.getItem('apiBaseUrl') || 'http://localhost:3000';
        let accessToken = localStorage.getItem('accessToken') || '';
        let refreshToken = localStorage.getItem('refreshToken') || '';
        let vars = JSON.parse(localStorage.getItem('apiVars') || '{}');
        let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');
        let stats = {
            total: 0,
            active: 0,
            success: 0,
            errors: 0
        };

        // ---- Presets (ALL DATA) ----
        const PRESETS = [
          // Public
          { key: 'health', name: 'Health Check', method: 'GET', path: '/api/health', requiresAuth: false },
          { key: 'apiInfo', name: 'API Info', method: 'GET', path: '/api', requiresAuth: false },

          // Auth
          {
            key: 'auth.register',
            name: 'Auth - Register',
            method: 'POST',
            path: '/api/auth/register',
            requiresAuth: false,
            body: { username: 'tu_${TS8}', password: 'password123', email: 'test_${TS8}@example.com' },
            onSuccess: (json) => {
              const at = json?.data?.accessToken;
              const rt = json?.data?.refreshToken;
              const uid = json?.data?.user?._id || json?.data?.user?.id;
              if (at) setAccessToken(at);
              if (rt) setRefreshToken(rt);
              if (uid) setVar('USER_ID', uid);
            }
          },
          {
            key: 'auth.login',
            name: 'Auth - Login',
            method: 'POST',
            path: '/api/auth/login',
            requiresAuth: false,
            body: { username: '${LAST_USERNAME}', password: 'password123' },
            onSuccess: (json) => {
              const at = json?.data?.accessToken;
              const rt = json?.data?.refreshToken;
              const uid = json?.data?.user?._id || json?.data?.user?.id;
              if (at) setAccessToken(at);
              if (rt) setRefreshToken(rt);
              if (uid) setVar('USER_ID', uid);
            }
          },
          {
            key: 'auth.refresh',
            name: 'Auth - Refresh Token',
            method: 'POST',
            path: '/api/auth/refresh',
            requiresAuth: false,
            body: { refreshToken: '${REFRESH_TOKEN}' },
            onSuccess: (json) => {
              const at = json?.data?.accessToken;
              const rt = json?.data?.refreshToken;
              if (at) setAccessToken(at);
              if (rt) setRefreshToken(rt);
            }
          },
          {
            key: 'auth.logout',
            name: 'Auth - Logout',
            method: 'POST',
            path: '/api/auth/logout',
            requiresAuth: true,
            body: { refreshToken: '${REFRESH_TOKEN}' }
          },

          // Users
          { key: 'users.me', name: 'Users - Get Me', method: 'GET', path: '/api/users/me', requiresAuth: true },
          { key: 'users.search', name: 'Users - Search (query=test)', method: 'GET', path: '/api/users/search/test?limit=20', requiresAuth: true },
          { key: 'users.updateProfile', name: 'Users - Update Profile', method: 'PUT', path: '/api/users/me', requiresAuth: true, body: { username: 'newname_${TS}', email: 'new_${TS}@example.com' } },
          { key: 'users.statusUpdate', name: 'Users - Update Status', method: 'PUT', path: '/api/users/status', requiresAuth: true, body: { status: 'online' } },
          { key: 'users.getStatus', name: 'Users - Get User Status', method: 'GET', path: '/api/users/${USER_ID}/status', requiresAuth: true },
          { key: 'users.friendsStatus', name: 'Users - Get Friends Status', method: 'GET', path: '/api/users/friends/status', requiresAuth: true },

          // Block
          { key: 'users.block', name: 'Users - Block User', method: 'POST', path: '/api/users/block', requiresAuth: true, body: { userId: '${USER_ID_TARGET}' } },
          { key: 'users.unblock', name: 'Users - Unblock User', method: 'POST', path: '/api/users/unblock', requiresAuth: true, body: { userId: '${USER_ID_TARGET}' } },
          { key: 'users.blocked', name: 'Users - List Blocked', method: 'GET', path: '/api/users/blocked?limit=50&skip=0', requiresAuth: true },
          { key: 'users.blockCheck', name: 'Users - Check Block Status', method: 'GET', path: '/api/users/check/${USER_ID_TARGET}', requiresAuth: true },

          // Groups
          {
            key: 'groups.create',
            name: 'Groups - Create',
            method: 'POST',
            path: '/api/groups',
            requiresAuth: true,
            body: { name: 'My Group ${TS}', description: 'Group description', isPrivate: false },
            onSuccess: (json) => {
              const gid = json?._id || json?.data?._id || json?.data?.group?._id;
              if (gid) setVar('GROUP_ID', gid);
            }
          },
          { key: 'groups.list', name: 'Groups - List (my)', method: 'GET', path: '/api/groups?type=my&limit=50&skip=0', requiresAuth: true },
          { key: 'groups.get', name: 'Groups - Get', method: 'GET', path: '/api/groups/${GROUP_ID}', requiresAuth: true },
          { key: 'groups.update', name: 'Groups - Update', method: 'PUT', path: '/api/groups/${GROUP_ID}', requiresAuth: true, body: { name: 'Updated Group ${TS}', description: 'Updated', isPrivate: true } },
          { key: 'groups.members', name: 'Groups - Get Members', method: 'GET', path: '/api/groups/${GROUP_ID}/members', requiresAuth: true },
          { key: 'groups.addMember', name: 'Groups - Add Member', method: 'POST', path: '/api/groups/${GROUP_ID}/members', requiresAuth: true, body: { userId: '${USER_ID_TARGET}' } },
          { key: 'groups.removeMember', name: 'Groups - Remove Member', method: 'DELETE', path: '/api/groups/${GROUP_ID}/members/${USER_ID_TARGET}', requiresAuth: true },
          { key: 'groups.promote', name: 'Groups - Promote Member', method: 'POST', path: '/api/groups/${GROUP_ID}/members/${USER_ID_TARGET}/promote', requiresAuth: true },
          { key: 'groups.demote', name: 'Groups - Demote Admin', method: 'POST', path: '/api/groups/${GROUP_ID}/members/${USER_ID_TARGET}/demote', requiresAuth: true },
          { key: 'groups.delete', name: 'Groups - Delete', method: 'DELETE', path: '/api/groups/${GROUP_ID}', requiresAuth: true },
          {
            key: 'message.send',
            name: 'Message - Send Text',
            method: 'POST',
            path: '/api/message/send',
            requiresAuth: true,
            body: { roomId: '${ROOM_ID}', text: 'Hello world ${TS}' },
            onSuccess: (json) => {
              const mid = json?.data?._id || json?._id;
              if (mid) setVar('MESSAGE_ID', mid);
            }
          },
          { key: 'message.get', name: 'Message - Get Messages', method: 'GET', path: '/api/message/${ROOM_ID}?limit=50&skip=0', requiresAuth: true },
          { key: 'message.reply', name: 'Message - Send Reply', method: 'POST', path: '/api/message/send', requiresAuth: true, body: { roomId: '${ROOM_ID}', text: 'reply ${TS}', replyToMessageId: '${MESSAGE_ID}' } },
          { key: 'message.update', name: 'Message - Update', method: 'PUT', path: '/api/message/${MESSAGE_ID}', requiresAuth: true, body: { text: 'Updated ${TS}' } },
          { key: 'message.replies', name: 'Message - Get Replies', method: 'GET', path: '/api/message/${MESSAGE_ID}/replies?limit=50&skip=0', requiresAuth: true },
          { key: 'message.mentionsMe', name: 'Message - Mentions Me', method: 'GET', path: '/api/message/mentions/me?limit=50&skip=0', requiresAuth: true },
          { key: 'message.reactionAdd', name: 'Message - Add Reaction', method: 'POST', path: '/api/message/${MESSAGE_ID}/reaction', requiresAuth: true, body: { emoji: 'üëç' } },
          { key: 'message.reactions', name: 'Message - Get Reactions', method: 'GET', path: '/api/message/${MESSAGE_ID}/reactions', requiresAuth: true },
          { key: 'message.read', name: 'Message - Mark Read', method: 'POST', path: '/api/message/${MESSAGE_ID}/read', requiresAuth: true },
          { key: 'message.readAll', name: 'Message - Mark All Read', method: 'POST', path: '/api/message/room/${ROOM_ID}/read-all', requiresAuth: true },
          { key: 'message.delete', name: 'Message - Delete', method: 'DELETE', path: '/api/message/${MESSAGE_ID}', requiresAuth: true },

          // Notifications
          { key: 'noti.get', name: 'Notifications - Get', method: 'GET', path: '/api/notifications?limit=50&skip=0&unreadOnly=false', requiresAuth: true },
          { key: 'noti.markRead', name: 'Notifications - Mark Read', method: 'PUT', path: '/api/notifications/${NOTIFICATION_ID}/read', requiresAuth: true },
          { key: 'noti.markAllRead', name: 'Notifications - Mark All Read', method: 'PUT', path: '/api/notifications/read-all', requiresAuth: true },

          // Friends (needs USER_ID_TARGET / REQUEST_ID / FRIEND_ID)
          { key: 'friends.request', name: 'Friends - Send Request', method: 'POST', path: '/api/friends/request', requiresAuth: true, body: { userId: '${USER_ID_TARGET}' } },
          { key: 'friends.accept', name: 'Friends - Accept', method: 'POST', path: '/api/friends/accept', requiresAuth: true, body: { requestId: '${REQUEST_ID}' } },
          { key: 'friends.reject', name: 'Friends - Reject', method: 'POST', path: '/api/friends/reject', requiresAuth: true, body: { requestId: '${REQUEST_ID}' } },
          { key: 'friends.requests', name: 'Friends - List Requests', method: 'GET', path: '/api/friends/requests?type=received&limit=50&skip=0', requiresAuth: true },
          { key: 'friends.list', name: 'Friends - List', method: 'GET', path: '/api/friends?limit=50&skip=0', requiresAuth: true },
          { key: 'friends.remove', name: 'Friends - Remove', method: 'DELETE', path: '/api/friends/${FRIEND_ID}', requiresAuth: true }
        ];

        // Defaults for vars
        if (!vars.ROOM_ID) vars.ROOM_ID = 'room123';
        if (!vars.USER_ID_TARGET) vars.USER_ID_TARGET = '';
        if (!vars.NOTIFICATION_ID) vars.NOTIFICATION_ID = '';
        if (!vars.REQUEST_ID) vars.REQUEST_ID = '';
        if (!vars.FRIEND_ID) vars.FRIEND_ID = '';

        function saveVars() {
          localStorage.setItem('apiVars', JSON.stringify(vars));
          const varsTextarea = document.getElementById('vars-json');
          if (varsTextarea) varsTextarea.value = JSON.stringify(vars, null, 2);
        }
        function setVar(key, value) {
          if (!key) return;
          vars[key] = value;
          saveVars();
        }
        function setAccessToken(token) {
          accessToken = token || '';
          localStorage.setItem('accessToken', accessToken);
          const input = document.getElementById('access-token');
          if (input) input.value = accessToken;
        }
        function setRefreshToken(token) {
          refreshToken = token || '';
          localStorage.setItem('refreshToken', refreshToken);
          const input = document.getElementById('refresh-token');
          if (input) input.value = refreshToken;
        }

        function substituteTemplate(value) {
          const ts = Date.now().toString();
          const ts8 = ts.slice(-8);
          const lastUsername = localStorage.getItem('lastUsername') || `testuser_${ts}`;
          if (typeof value === 'string') {
            return value
              .replaceAll('${TS}', ts)
              .replaceAll('${TS8}', ts8)
              .replaceAll('${ACCESS_TOKEN}', accessToken || '')
              .replaceAll('${REFRESH_TOKEN}', refreshToken || '')
              .replaceAll('${LAST_USERNAME}', lastUsername)
              .replaceAll('${ROOM_ID}', vars.ROOM_ID || 'room123')
              .replaceAll('${USER_ID}', vars.USER_ID || '')
              .replaceAll('${GROUP_ID}', vars.GROUP_ID || '')
              .replaceAll('${MESSAGE_ID}', vars.MESSAGE_ID || '')
              .replaceAll('${USER_ID_TARGET}', vars.USER_ID_TARGET || '')
              .replaceAll('${NOTIFICATION_ID}', vars.NOTIFICATION_ID || '')
              .replaceAll('${REQUEST_ID}', vars.REQUEST_ID || '')
              .replaceAll('${FRIEND_ID}', vars.FRIEND_ID || '');
          }
          if (Array.isArray(value)) return value.map(substituteTemplate);
          if (value && typeof value === 'object') {
            const out = {};
            for (const k of Object.keys(value)) out[k] = substituteTemplate(value[k]);
            return out;
          }
          return value;
        }

        function getPresetByKey(key) {
          return PRESETS.find(p => p.key === key);
        }

        function renderPresetsSelect() {
          const sel = document.getElementById('preset-select');
          if (!sel) return;
          sel.innerHTML = '';
          PRESETS.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.key;
            opt.textContent = `${p.method} ${p.path} ‚Äî ${p.name}`;
            sel.appendChild(opt);
          });
        }

        function loadSelectedPreset() {
          const sel = document.getElementById('preset-select');
          if (!sel) return;
          const preset = getPresetByKey(sel.value);
          if (!preset) return;
          document.getElementById('test-method').value = preset.method;
          document.getElementById('test-url').value = `${API_BASE}${substituteTemplate(preset.path)}`;
          document.getElementById('test-headers').value = '';
          const body = preset.body ? substituteTemplate(preset.body) : '';
          document.getElementById('test-body').value = body ? JSON.stringify(body, null, 2) : '';
        }

        async function runSelectedPreset() {
          const sel = document.getElementById('preset-select');
          if (!sel) return;
          await runPreset(sel.value, { showIn: 'test' });
        }

        function renderQuickTests() {
          const list = document.getElementById('quicktests-list');
          if (!list) return;
          list.innerHTML = '';
          PRESETS.forEach(p => {
            const item = document.createElement('div');
            item.className = 'endpoint-item';
            const methodClass = `method-${p.method.toLowerCase()}`;
            const authBadge = p.requiresAuth
              ? '<span class="status-badge status-pending" style="margin-left:8px;">AUTH</span>'
              : '<span class="status-badge status-success" style="margin-left:8px;">PUBLIC</span>';
            item.innerHTML = `
              <div class="endpoint-info">
                <span class="endpoint-method ${methodClass}">${p.method}</span>
                <span class="endpoint-path">${p.path}</span>
                ${authBadge}
                <div style="color:#aaa; font-size:12px; margin-top:6px;">${p.name}</div>
              </div>
              <div class="endpoint-actions">
                <button class="btn btn-secondary" onclick="loadPresetToTest('${p.key}')">Load</button>
                <button class="btn btn-primary" onclick="runPreset('${p.key}', { showIn: 'quick' })">Run</button>
              </div>
            `;
            list.appendChild(item);
          });
        }

        function loadPresetToTest(key) {
          const preset = getPresetByKey(key);
          if (!preset) return;
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
          document.querySelector('[data-page="test"]').classList.add('active');
          document.getElementById('page-test').classList.remove('hidden');
          document.getElementById('page-title').textContent = 'Test API';
          const sel = document.getElementById('preset-select');
          if (sel) sel.value = key;
          loadSelectedPreset();
        }

        async function runPreset(key, opts = {}) {
          const preset = getPresetByKey(key);
          if (!preset) return;

          const method = preset.method;
          const url = `${API_BASE}${substituteTemplate(preset.path)}`;

          // Build headers
          const headers = { 'Content-Type': 'application/json' };
          if (preset.requiresAuth) {
            // N·∫øu ch∆∞a c√≥ accessToken nh∆∞ng c√≥ refreshToken, auto refresh tr∆∞·ªõc
            if (!accessToken && refreshToken && key !== 'auth.refresh') {
              const refreshResult = await runPreset('auth.refresh', { showIn: opts.showIn || 'quick' });
              if (!refreshResult?.ok) {
                alert('Cannot auto-refresh token. Please login or set token in Settings.');
                return;
              }
            }
            if (!accessToken) {
              alert('Missing accessToken. Login/Register first or set token in Settings.');
              return;
            }
            headers['Authorization'] = `Bearer ${accessToken}`;
          }

          const options = { method, headers };
          if (preset.body && (method === 'POST' || method === 'PUT')) {
            options.body = JSON.stringify(substituteTemplate(preset.body));
          }

          // Track lastUsername if this is register
          if (key === 'auth.register') {
            const body = substituteTemplate(preset.body);
            if (body?.username) localStorage.setItem('lastUsername', body.username);
          }

          stats.active++;
          updateStats();
          const startTime = Date.now();

          try {
            const response = await fetch(url, options);
            const endTime = Date.now();
            const responseTime = endTime - startTime;

            const contentType = response.headers.get('content-type');
            let responseData;
            if (contentType && contentType.includes('application/json')) {
              responseData = await response.json();
            } else {
              responseData = await response.text();
            }

            stats.active--;
            if (response.ok) stats.success++; else stats.errors++;
            updateStats();

            addActivity(method, url, response.status, responseTime);

            // Save vars from response if any
            if (response.ok && typeof preset.onSuccess === 'function') {
              try { preset.onSuccess(responseData); } catch (_) {}
            }

            // Auto-pick notificationId/requestId/messageId if list returns items
            if (response.ok) {
              const firstNoti = responseData?.data?.notifications?.[0];
              if (firstNoti?._id) setVar('NOTIFICATION_ID', firstNoti._id);
              const firstReq = responseData?.data?.requests?.[0];
              if (firstReq?._id) setVar('REQUEST_ID', firstReq._id);
              const firstFriend = responseData?.data?.friends?.[0];
              if (firstFriend?.userId) setVar('FRIEND_ID', firstFriend.userId);
            }

            // Show response
            if (opts.showIn === 'quick') {
              const box = document.getElementById('quicktest-response');
              const pre = document.getElementById('quicktest-response-content');
              if (box && pre) {
                box.style.display = 'block';
                box.className = 'response-area' + (response.ok ? '' : ' error');
                pre.textContent = JSON.stringify(responseData, null, 2);
              }
            } else {
              // load into test panel response view
              const responseEl = document.getElementById('test-response');
              const contentEl = document.getElementById('test-response-content');
              if (responseEl && contentEl) {
                responseEl.style.display = 'block';
                responseEl.className = 'response-area' + (response.ok ? '' : ' error');
                contentEl.textContent = JSON.stringify(responseData, null, 2);
              }
            }

            return { ok: response.ok, status: response.status, data: responseData };
          } catch (error) {
            stats.active--;
            stats.errors++;
            updateStats();
            addActivity(method, url, 'ERROR', 0);
            if (opts.showIn === 'quick') {
              const box = document.getElementById('quicktest-response');
              const pre = document.getElementById('quicktest-response-content');
              if (box && pre) {
                box.style.display = 'block';
                box.className = 'response-area error';
                pre.textContent = `Error: ${error.message}`;
              }
            }
            return { ok: false, status: 'ERROR', error: error.message };
          }
        }

        async function runSmokeTest() {
          // Safe-ish flow: health -> api -> register -> me -> refresh -> groups list -> send message -> get messages
          const steps = [
            'health',
            'apiInfo',
            'auth.register',
            'users.me',
            'auth.refresh',
            'groups.list',
            'message.send',
            'message.get'
          ];
          for (const key of steps) {
            // eslint-disable-next-line no-await-in-loop
            const r = await runPreset(key, { showIn: 'quick' });
            if (!r?.ok) break;
          }
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                item.classList.add('active');
                const page = item.dataset.page;
                document.getElementById(`page-${page}`).classList.remove('hidden');
                document.getElementById('page-title').textContent = item.textContent.trim();
            });
        });

        // Load initial data
        async function init() {
            checkServerStatus();
            loadEndpoints();
            loadActivity();
            updateStats();
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const statusEl = document.getElementById('server-status');
                if (response.ok) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'status-badge status-success';
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                const statusEl = document.getElementById('server-status');
                statusEl.textContent = 'Offline';
                statusEl.className = 'status-badge status-error';
            }
        }

        async function loadEndpoints() {
            try {
                const response = await fetch(`${API_BASE}/api`);
                const data = await response.json();
                
                if (data.endpoints) {
                    stats.total = countEndpoints(data.endpoints);
                    updateStats();
                    displayEndpoints(data.endpoints);
                    displayServerInfo(data);
                }
            } catch (error) {
                console.error('Failed to load endpoints:', error);
                document.getElementById('endpoints-list').innerHTML = 
                    '<div style="color: #f44336; text-align: center; padding: 20px;">Failed to load endpoints</div>';
            }
        }

        function countEndpoints(endpoints) {
            let count = 0;
            function traverse(obj) {
                for (const key in obj) {
                    if (typeof obj[key] === 'string') {
                        count++;
                    } else if (typeof obj[key] === 'object') {
                        traverse(obj[key]);
                    }
                }
            }
            traverse(endpoints);
            return count;
        }

        function displayEndpoints(endpoints) {
            const list = document.getElementById('endpoints-list');
            list.innerHTML = '';
            
            function addEndpoint(method, path, category = '') {
                const item = document.createElement('div');
                item.className = 'endpoint-item';
                const methodClass = `method-${method.toLowerCase()}`;
                item.innerHTML = `
                    <div class="endpoint-info">
                        <span class="endpoint-method ${methodClass}">${method}</span>
                        <span class="endpoint-path">${path}</span>
                    </div>
                    <div class="endpoint-actions">
                        <button class="btn btn-secondary" onclick="testEndpoint('${method}', '${path}')">Test</button>
                    </div>
                `;
                list.appendChild(item);
            }

            function traverse(obj, prefix = '') {
                for (const key in obj) {
                    if (typeof obj[key] === 'string') {
                        const [method, path] = obj[key].split(' ');
                        addEndpoint(method, path, prefix);
                    } else if (typeof obj[key] === 'object') {
                        traverse(obj[key], key);
                    }
                }
            }

            traverse(endpoints);
        }

        function displayServerInfo(data) {
            const info = document.getElementById('server-info');
            info.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>Version:</strong> ${data.version || 'N/A'}</div>
                <div style="margin-bottom: 10px;"><strong>Message:</strong> ${data.message || 'N/A'}</div>
                <div><strong>Base URL:</strong> ${API_BASE}</div>
            `;
        }

        function testEndpoint(method, path) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.querySelector('[data-page="test"]').classList.add('active');
            document.getElementById('page-test').classList.remove('hidden');
            document.getElementById('page-title').textContent = 'Test API';
            
            document.getElementById('test-method').value = method;
            document.getElementById('test-url').value = `${API_BASE}${path}`;
        }

        async function handleTestSubmit(event) {
            event.preventDefault();
            stats.active++;
            updateStats();
            
            const method = document.getElementById('test-method').value;
            const url = document.getElementById('test-url').value;
            const headersText = document.getElementById('test-headers').value;
            const bodyText = document.getElementById('test-body').value;

            const headers = {
                'Content-Type': 'application/json'
            };

            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }

            try {
                if (headersText) {
                    Object.assign(headers, JSON.parse(headersText));
                }
            } catch (e) {
                alert('Invalid headers JSON');
                return;
            }

            const options = {
                method: method,
                headers: headers
            };

            if (bodyText && (method === 'POST' || method === 'PUT')) {
                try {
                    options.body = bodyText;
                } catch (e) {
                    alert('Invalid body JSON');
                    return;
                }
            }

            const startTime = Date.now();
            try {
                const response = await fetch(url, options);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                let responseData;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                const responseEl = document.getElementById('test-response');
                const contentEl = document.getElementById('test-response-content');
                responseEl.style.display = 'block';
                responseEl.className = 'response-area' + (response.ok ? '' : ' error');
                contentEl.textContent = JSON.stringify(responseData, null, 2);
                
                stats.active--;
                if (response.ok) {
                    stats.success++;
                } else {
                    stats.errors++;
                }
                updateStats();

                addActivity(method, url, response.status, responseTime);
            } catch (error) {
                stats.active--;
                stats.errors++;
                updateStats();
                
                const responseEl = document.getElementById('test-response');
                const contentEl = document.getElementById('test-response-content');
                responseEl.style.display = 'block';
                responseEl.className = 'response-area error';
                contentEl.textContent = `Error: ${error.message}`;
                
                addActivity(method, url, 'ERROR', 0);
            }
        }

        function addActivity(method, url, status, time) {
            const activity = {
                method,
                url,
                status,
                time,
                timestamp: new Date().toISOString()
            };
            activityLog.unshift(activity);
            if (activityLog.length > 50) {
                activityLog = activityLog.slice(0, 50);
            }
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            loadActivity();
        }

        function loadActivity() {
            const list = document.getElementById('activity-list');
            if (activityLog.length === 0) {
                list.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No activity yet</div>';
                return;
            }

            list.innerHTML = activityLog.map(activity => {
                const time = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(time);
                const statusClass = activity.status === 'ERROR' || activity.status >= 400 
                    ? 'status-error' 
                    : 'status-success';
                
                return `
                    <div class="activity-item">
                        <div class="activity-avatar">${activity.method.charAt(0)}</div>
                        <div class="activity-content">
                            <div><strong>${activity.method}</strong> ${activity.url}</div>
                            <div class="activity-time">${timeAgo} - <span class="status-badge ${statusClass}">${activity.status}</span> ${activity.time}ms</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-active').textContent = stats.active;
            const totalRequests = stats.success + stats.errors;
            const successRate = totalRequests > 0 ? Math.round((stats.success / totalRequests) * 100) : 0;
            document.getElementById('stat-success').textContent = successRate + '%';
            document.getElementById('stat-errors').textContent = stats.errors;
        }

        function saveSettings() {
            const baseUrl = document.getElementById('base-url').value;
            const token = document.getElementById('access-token').value;
            const rToken = document.getElementById('refresh-token').value;
            const varsText = document.getElementById('vars-json').value;

            localStorage.setItem('apiBaseUrl', baseUrl);
            localStorage.setItem('accessToken', token);
            localStorage.setItem('refreshToken', rToken);
            accessToken = token;
            refreshToken = rToken;

            // Optional: save vars if JSON h·ª£p l·ªá
            try {
              if (varsText && varsText.trim().length > 0) {
                const v = JSON.parse(varsText);
                if (v && typeof v === 'object') {
                  vars = v;
                  saveVars();
                }
              }
            } catch (e) {
              // ignore, ch·ªâ c·∫£nh b√°o nh·ªè
              console.warn('Invalid vars JSON in Settings:', e.message);
            }

            alert('Settings saved!');
        }

        // Load settings
        document.getElementById('base-url').value = API_BASE;
        document.getElementById('access-token').value = accessToken;
        document.getElementById('refresh-token').value = refreshToken;
        document.getElementById('vars-json').value = JSON.stringify(vars, null, 2);

        // allow editing vars json
        document.getElementById('vars-json').addEventListener('change', () => {
          try {
            const v = JSON.parse(document.getElementById('vars-json').value || '{}');
            vars = v && typeof v === 'object' ? v : {};
            saveVars();
            alert('Variables saved!');
          } catch (e) {
            alert('Invalid vars JSON');
          }
        });

        // Initialize
        init();
        renderPresetsSelect();
        renderQuickTests();
        setInterval(checkServerStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>

